<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>4</storyId>
    <title>Returning Player Recognition</title>
    <status>drafted</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/0-4-returning-player-recognition.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>registered bridge player</asA>
    <iWant>to see a personalized main menu</iWant>
    <soThat>I can immediately access relevant functions</soThat>
    <tasks>
      <task ac="1">Implement personalized greeting system - Create player recognition logic using Discord ID, Implement personalized greeting with player name display, Handle greeting for verified vs unverified players</task>
      <task ac="2">Create dynamic main menu options - Design returning player main menu layout, Implement Find Partner button for registered players, Add Register and View Tournaments options, Create menu option visibility based on player status</task>
      <task ac="3">Implement quick access buttons - Identify most common player actions from user flows, Create quick access button components, Implement quick action handlers</task>
      <task ac="4">Create new player registration menu - Design registration-focused menu for new players, Implement conditional menu display logic, Create clear call-to-action for unregistered players</task>
      <task ac="5">Optimize profile loading performance - Implement efficient player profile lookup, Add profile caching mechanisms, Create loading indicators, Test and optimize for 2-second response requirement</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Returning players see personalized greeting with their name</criterion>
    <criterion id="2">Main menu shows relevant options (Find Partner, Register, View Tournaments)</criterion>
    <criterion id="3">Quick access buttons for common actions</criterion>
    <criterion id="4">New players see registration-focused menu</criterion>
    <criterion id="5">System handles profile loading within 2 seconds</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 0 Story 0.4</section>
        <snippet>Personalized main menu for registered players, recognition system, quick access buttons, 2-second profile loading requirement</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Performance Considerations</section>
        <snippet>Response times under 5 seconds, database optimization with connection pooling, GIN indexes on JSONB columns</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Discord State Bridge Pattern</section>
        <snippet>Maintain user context and provide real-time status updates, session store for workflow progress</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>UX Design Principles</section>
        <snippet>Elderly-friendly simplicity with clear navigation, personalized experiences, quick access patterns</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/interactions/PlayerRecognition.ts</path>
        <kind>interaction-handler</kind>
        <symbol>PlayerRecognitionHandler</symbol>
        <lines>N/A - to be created</lines>
        <reason>Player identification and personalized greeting logic</reason>
      </artifact>
      <artifact>
        <path>src/menus/MainMenu.ts</path>
        <kind>menu-component</kind>
        <symbol>EnhancedMainMenu</symbol>
        <lines>N/A - to be created</lines>
        <reason>Enhanced main menu with personalization and dynamic options</reason>
      </artifact>
      <artifact>
        <path>src/services/PlayerProfileService.ts</path>
        <kind>service</kind>
        <symbol>OptimizedProfileService</symbol>
        <lines>N/A - to be created</lines>
        <reason>Optimized profile loading with caching for sub-2-second performance</reason>
      </artifact>
    </code>
    <dependencies>
      <nodejs>
        <package name="discord.js" version="^14.24.2" />
        <package name="@supabase/supabase-js" version="latest" />
        <package name="node-cache" version="latest" />
      </nodejs>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Must integrate with profile creation from Story 0.3</constraint>
    <constraint>Profile loading must complete within 2 seconds (performance requirement)</constraint>
    <constraint>Conditional menu rendering based on player registration status</constraint>
    <constraint>Personalized greeting requires player name from FFB verification</constraint>
    <constraint>Quick access patterns must align with most common user actions</constraint>
    <constraint>Database queries must be optimized with proper indexing for fast lookup</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Player Recognition Interface</name>
      <kind>Discord ID Lookup Service</kind>
      <signature>recognizePlayer(discordId: string): Promise&lt;PlayerRecognitionResult&gt;</signature>
      <path>src/interactions/PlayerRecognition.ts</path>
    </interface>
    <interface>
      <name>Dynamic Menu Interface</name>
      <kind>Discord Button Components</kind>
      <signature>Conditional menu rendering with personalized options based on player status</signature>
      <path>src/menus/MainMenu.ts</path>
    </interface>
    <interface>
      <name>Profile Cache Interface</name>
      <kind>Caching Service</kind>
      <signature>getCachedProfile(discordId: string): Promise&lt;CachedProfile | null&gt;</signature>
      <path>src/services/PlayerProfileService.ts</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Player recognition flow testing with various registration states, menu personalization testing, performance testing for 2-second profile loading requirement, caching mechanism validation</standards>
    <locations>tests/integration/player-recognition/, tests/unit/menu-personalization/, tests/performance/profile-loading/</locations>
    <ideas>
      <test ac="1">Personalized greeting test with registered vs unregistered players</test>
      <test ac="2">Dynamic menu options test based on player status</test>
      <test ac="3">Quick access button functionality and routing test</test>
      <test ac="4">New player menu display and registration flow test</test>
      <test ac="5">Profile loading performance test with 2-second constraint validation</test>
    </ideas>
  </tests>
</story-context>